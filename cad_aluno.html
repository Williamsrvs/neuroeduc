<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cadastrar Aluno - NeuroEduc</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"/>

    <!-- App CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"/>
    <style>

            html, body {
            height: 100%;
            margin: 20;
            padding: 10;
        }
        
        body {
            min-height: 100vh;
            margin: 0;
            justify-items: center;
            align-items: center;
            background-image: url("static/img/neuroeduc1.png");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .conteudo-central {
            background-color: rgba(255, 255, 255, 0.178);
            padding: 60px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-width: 1350px;
            width: 95%;
            margin-left: auto;
            margin-right: 100px;
        }

        .form-section-title {
          background: linear-gradient(90deg, #b47988, #fdfcfc); /* degrade vinho */
          color: white; /* cor do texto */
          font-size: 1.6rem; /* aumenta o tamanho */
          font-weight: bold; /* deixa em negrito */
          padding: 12px 20px; /* espaçamento interno */
          border-radius: 10px; /* cantos arredondados */
          margin-bottom: 20px; /* espaço embaixo */
          text-shadow: 1px 1px 3px rgba(0,0,0,0.3); /* leve sombra no texto */

        }

        .form-container {
            background: #ffffff31;
            padding: 60px;
            max-width: 1300px;  
            width: 90%;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            margin-left: 0px;
            margin-right: 65px;
        }

        .btn-vinho {
            background-color: #800020;
            color: white;
        }

        .btn-vinho:hover {
            background-color: #66001a;
        }

        .logo {
            max-width: 120px;
        }

        .title-text {
            
            color: #800020;
            font-weight: 700;
            font-size: 42px;
        
        }

        .form-section-title {
            font-size: 1.3rem;
            color: #faf9f9;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .title-text {
            color: #800020;
            font-weight: 700;
            font-size: 42px;
        }

        .gradient-icon {
            background: linear-gradient(90deg, #b47988, #fdfcfc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-label {
            font-weight: 500;   
            font-size: 14px;
        }

        .tab-pane {
            padding-top: 25px;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>
<body>
<div class="container mt-5 mb-5">
    <h1 class="page-title mb-3 title-text">
                    <i class="bi bi-clipboard-data me-2"></i>
                    Cadastro de Alunos
                </h1>
<div class="row align-items-end mb-3">
    <div class="col-md-8">
        <label for="matricula_aluno" class="form-label title-text">Pesquisar matrícula</label>
        <input type="text" class="form-control" id="matricula_aluno" name="matricula_aluno" placeholder="Digite a matrícula do aluno">
    </div>
    <div class="col-md-4">
        <label class="form-label d-block invisible flex-fill ">Pesquisar</label>
        <button type="button" class="btn btn-primary w-80" id="btnPesquisar">
            <i class="bi bi-search"></i> Pesquisar
        </button>
    

    </div>
</div>
</div>      
</div>  

    <div class="form-container">
        <div class="text-center mb-4">
        <!--pesquisar aluno-->
        <h1 class="page-title mb-3 title-text">
    <i class="bi bi-pencil me-2 gradient-icon"></i>
    Preencha os Campos do Formulário Abaixo
</h1>

        </div>
    
    <form method="POST" action="{{ url_for('cad_aluno') }}">
        <input type="hidden" id="matricula_hidden" name="matricula_aluno">

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="nome_aluno" class="form-label">Nome do Aluno</label>
                <input type="text" class="form-control" id="nome_aluno" name="nome_aluno" required>
            </div>
            <div class="col-md-3">  
                <label for="dt_nascimento" class="form-label">Data de Nascimento</label>
                <input type="date" class="form-control" id="dt_nascimento" name="dt_nascimento" required>
            </div>
            <div class="col-md-3">
                <label for="genero" class="form-label">Gênero</label>
                <select class="form-select" id="genero" name="genero" required>
                    <option value="">Selecione</option>
                    <option value="Masc">Masculino</option>
                    <option value="Fem">Feminino</option>
                    <option value="Não Informado">Não Informado</option>
                </select>
            </div>
        </div>
        <div class="mb-3">
            <label for="endereco_aluno" class="form-label">Endereço</label>
            <input type="text" class="form-control" id="endereco_aluno" name="endereco_aluno">
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="tipo_responsavel" class="form-label">Tipo de Responsável</label>
                <select class="form-select" id="tipo_responsavel" name="tipo_responsavel" required>
                    <option value="">Selecione</option>
                    <option value="Pais">Pais</option>
                    <option value="Avós Materno ou Paterno">Avós Materno ou Paterno</option>
                    <option value="Tios ou Tias">Tios ou Tias</option>
                    <option value="Irmãos">Irmãos</option>
                    <option value="Outros Não Listado">Outros Não Listado</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="nome_pai" class="form-label">Nome do Pai / Responsável</label>
                <input type="text" class="form-control" id="nome_pai" name="nome_pai">
            </div>
            <div class="col-md-4">
                <label for="nome_mae" class="form-label">Nome da Mãe / Responsável</label>
                <input type="text" class="form-control" id="nome_mae" name="nome_mae">
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="patologia" class="form-label">Patologia</label>
                <select class="form-select" id="patologia" name="patologia" required>
                    <option value="">Selecione</option>
                    <option value="Autismo">Autismo</option>
                    <option value="Sindrome Down">Síndrome de Down</option>
                    <option value="Deficiência Intelectual">Deficiência Intelectual</option>
                    <option value="Deficiência Física">Deficiência Física</option>
                    <option value="Deficiência Visual">Deficiência Visual</option>
                    <option value="Deficiência Auditiva">Deficiência Auditiva</option>
                    <option value="Transtorno Déficit Atenção">Transtorno Déficit Atenção</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="tipo_educacao" class="form-label">Tipo de Educação</label>
                <select class="form-select" id="tipo_educacao" name="tipo_educacao" required>
                    <option value="">Selecione</option>
                    <option value="AEE">AEE</option>
                    <option value="EJAE">EJAE</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="contato" class="form-label">Contato</label>
                <input type="text" class="form-control" id="contato" name="contato" maxlength="15">
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="nome_escola" class="form-label">Nome da Escola</label>
                <input type="text" class="form-control" id="nome_escola" name="nome_escola">
            </div>
            <div class="col-md-4">
                <label for="turma" class="form-label">Turma</label>
                <input type="text" class="form-control" id="turma" name="turma">
            </div>
            <div class="col-md-4">
                <label for="professor_regente" class="form-label">Professor Regente</label>
                <input type="text" class="form-control" id="professor_regente" name="professor_regente">
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="profissional_AEE" class="form-label">Profissional AEE</label>
                <input type="text" class="form-control" id="profissional_AEE" name="profissional_AEE">
            </div>
            <div class="col-md-4">
                <label for="cod_cid" class="form-label">Código CID</label>
                <input type="text" class="form-control" id="cod_cid" name="cod_cid">
            </div>
            <div class="col-md-4">
                <label for="equipe_multidisciplinar" class="form-label">Equipe Multidisciplinar</label>
                <input type="text" class="form-control" id="equipe_multidisciplinar" name="equipe_multidisciplinar">
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="status_aluno" class="form-label">Status do Aluno</label>
                <select class="form-select" id="status_aluno" name="status_aluno" required>
                    <option value="">Selecione</option>
                    <option value="Ativo">Ativo</option>
                    <option value="Inativo">Inativo</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
            <div class="col-md-8">
                <label for="observacoes" class="form-label">Observações</label>
                <textarea class="form-control" id="observacoes" name="observacoes" rows="2" maxlength="200"></textarea>
            </div>
        </div>
        <div class="mt-4 text-end">
            <button type="submit" class="btn btn-success" id="btnCadastrar">Cadastrar</button>
            <button type="button" class="btn btn-warning" id="btnAtualizar" style="display:none;">Atualizar</button>
            <a href="{{ url_for('home') }}" class="btn btn-secondary me-2">Retornar Home</a>
            <button type="print" class="btn btn-info" onclick="window.print();">Imprimir</button>
        </div>
    </form>
</div>
<script>
    function preencherFormulario(aluno) {
        
        document.getElementById('nome_aluno').value = aluno.nome_aluno || '';
        document.getElementById('dt_nascimento').value = aluno.dt_nascimento?.split('T')[0] || '';
        document.getElementById('genero').value = aluno.genero || '';
        document.getElementById('endereco_aluno').value = aluno.endereco_aluno || '';
        document.getElementById('tipo_responsavel').value = aluno.tipo_responsavel || '';   
        document.getElementById('nome_pai').value = aluno.nome_pai || '';
        document.getElementById('nome_mae').value = aluno.nome_mae || '';
        document.getElementById('patologia').value = aluno.patologia || '';
        document.getElementById('tipo_educacao').value = aluno.tipo_educacao || '';
        document.getElementById('contato').value = aluno.contato || '';
        document.getElementById('nome_escola').value = aluno.nome_escola || '';
        document.getElementById('turma').value = aluno.turma || '';
        document.getElementById('professor_regente').value = aluno.professor_regente || '';
        document.getElementById('profissional_AEE').value = aluno.profissional_AEE || '';
        document.getElementById('cod_cid').value = aluno.cod_cid || '';
        document.getElementById('equipe_multidisciplinar').value = aluno.equipe_multidisciplinar || '';
        document.getElementById('status_aluno').value = aluno.status_aluno || '';
        document.getElementById('observacoes').value = aluno.observacoes || '';
        document.getElementById('btnAtualizar').style.display = 'inline-block';
        document.getElementById('btnCadastrar').style.display = 'none';
        document.getElementById('matricula_hidden').value = aluno.matricula_aluno || '';

    }

document.getElementById('btnPesquisar').addEventListener('click', async function() {
    const matricula = document.getElementById('matricula_aluno').value.trim();
    if (!matricula) {
        showAlert('Por favor, digite uma matrícula para pesquisar', 'warning');
        return;
    }

    const btnPesquisar = this;
    const originalText = btnPesquisar.innerHTML;
    
    try {
        // Mostrar loading
        btnPesquisar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Pesquisando...';
        btnPesquisar.disabled = true;

        const response = await fetch(`/buscar_aluno?matricula_aluno=${encodeURIComponent(matricula)}`);

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.mensagem || 'Erro na requisição');
        }

        if (data.erro) {
            throw new Error(data.mensagem || 'Erro no servidor');
        }

        if (data.encontrado) {
            preencherFormulario(data.aluno);    

            document.getElementById('btnAtualizar').addEventListener('click', async function () {
    const formData = new FormData(document.querySelector('form'));

    const response = await fetch('/atualizar_aluno', {
        method: 'POST',
        body: formData
    });

    const data = await response.json();

    if (data.sucesso) {
        showAlert(data.mensagem, 'success');
    } else {
        showAlert(data.mensagem || 'Erro ao atualizar', 'danger');
    }
});

            showAlert('Dados do aluno carregados com sucesso!', 'success');
        } else {
            showAlert(data.mensagem || 'Aluno não encontrado', 'info');
        }
    } catch (error) {   
        console.error('Erro detalhado:', error);
        showAlert(error.message || 'Erro ao buscar aluno. Por favor, tente novamente.', 'danger');

    } finally {
        // Restaurar botão
        btnPesquisar.innerHTML = originalText;
        btnPesquisar.disabled = false;
    }
});

// Função auxiliar para mostrar alertas
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const container = document.querySelector('.form-container');
    if (container) {
        // Remove alertas anteriores
        document.querySelectorAll('.alert').forEach(alert => alert.remove());
        container.prepend(alertDiv);
    } else {
        alert(message); // Fallback
    }
}   